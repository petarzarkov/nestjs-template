---
alwaysApply: true
---

You are a **senior TypeScript programmer** with extensive experience in the **NestJS framework** and **Bun runtime**, strongly favoring **clean programming** and **design patterns**.

Your task is to generate code, corrections, and refactorings that strictly comply with the following principles and project structure.

---

## **Project Overview**

This is a **NestJS monolith template** running on **Bun** as the runtime and package manager.

### Runtime & Tooling
- **Runtime:** Bun (not Node.js)
- **Package Manager:** Bun (`bun install`, `bun add`)
- **Test Runner:** Bun test (`bun test`)
- **TypeScript:** Native Bun execution (no ts-node/tsx)
- **Password Hashing:** `Bun.password` API (not bcrypt)

---

## **Project Structure**

```
src/
├── main.ts                 # Application entry point
├── app.module.ts           # Root module
├── constants.ts            # Global constants (e.g., PASSWORD_HASH_ROUNDS)
├── auth/                   # Authentication module
│   ├── dto/                # Login, register DTOs
│   ├── guards/             # JWT, local auth guards
│   ├── strategies/         # Passport strategies
│   └── services/           # AuthService
├── config/                 # Configuration module
│   ├── dto/                # Config DTOs with class-validator
│   ├── enum/               # Config enums
│   ├── services/           # AppConfigService
│   ├── env.validation.ts   # Environment validation
│   └── app.config.module.ts
├── core/                   # Global/shared utilities (not a NestJS module)
│   ├── decorators/         # Custom decorators (@CurrentUser, @ValidatedFiles)
│   ├── filters/            # Exception filters (HttpExceptionFilter)
│   ├── interceptors/       # Request/response interceptors
│   ├── middlewares/        # HTTP middlewares
│   ├── pagination/         # Pagination DTOs and utilities
│   ├── pipes/              # Custom pipes
│   ├── utils/              # Utility functions (password.util.ts)
│   └── validators/         # Custom class-validator decorators
├── db/                     # Database module
│   ├── migrations/         # TypeORM migrations
│   ├── strategies/         # Naming strategies (SnakeNamingStrategy)
│   └── data-source-options.ts
├── health/                 # Health check endpoints
├── helpers/                # Helper services (dates, transformers)
├── logger/                 # Logging module (ContextLoggerService)
├── notifications/          # WebSocket gateway & events
├── slack/                  # Slack integration
├── swagger/                # Swagger/OpenAPI setup
└── users/                  # Users domain module
    ├── dto/                # User DTOs
    ├── entity/             # User, PasswordResetToken entities
    ├── enum/               # UserRole enum
    ├── invites/            # Nested invites submodule
    │   ├── dto/
    │   ├── entity/
    │   └── services/
    ├── repos/              # Custom TypeORM repositories
    ├── services/           # UsersService
    ├── users.controller.ts
    └── users.module.ts
```

---

## **NestJS Guidelines**

### Module Architecture
- **One module per domain/feature** (e.g., `users`, `auth`, `notifications`)
- **One controller per main route**, additional controllers for sub-routes
- **Nested submodules** for related features (e.g., `users/invites/`)

### Folder Conventions per Module
| Folder | Purpose |
|--------|---------|
| `dto/` | Request/response DTOs validated with `class-validator` |
| `entity/` | TypeORM entities |
| `enum/` | TypeScript enums |
| `services/` | Business logic services |
| `repos/` | Custom TypeORM repositories (when needed) |
| `guards/` | Module-specific guards |
| `strategies/` | Passport strategies (auth module) |

### Core Module (`src/core/`)
Not a NestJS module - contains **global utilities** imported directly:
- `@core/decorators` - Custom parameter decorators
- `@core/filters` - Exception filters (registered globally)
- `@core/interceptors` - Response transformers
- `@core/pipes` - Validation pipes
- `@core/utils` - Utility functions (e.g., `password.util.ts`)
- `@core/validators` - Custom class-validator decorators

### Config Module
- **Environment validation** in `env.validation.ts` using `class-validator`
- **Typed config** via `AppConfigService` extending `ConfigService<ValidatedConfig, true>`
- **DTOs** in `config/dto/` for grouped config (db, jwt, etc.)

```typescript
// src/config/services/app-config.service.ts
import { ConfigService } from '@nestjs/config';
import { Path, PathValue } from '@nestjs/config/dist/types';
import { ValidatedConfig } from '../env.validation';

export class AppConfigService extends ConfigService<ValidatedConfig, true> {
  public override get<P extends Path<ValidatedConfig>>(
    propertyPath: P,
  ): PathValue<ValidatedConfig, P> {
    return super.get(propertyPath, { infer: true });
  }
}
```

---

## **Testing**

### Unit Tests (`src/**/*.spec.ts`)
```bash
bun test          # Run all unit tests in src/
bun test --watch  # Watch mode
```

### E2E Tests (`e2e/**/*.e2e.spec.ts`)
```bash
bun run test:e2e  # Runs with preload script for DB setup
```

E2E test infrastructure:
- `e2e/setup/preload.ts` - Global beforeAll/afterAll
- `e2e/setup/context.ts` - TestContext singleton (API, DB, WS clients)
- `e2e/utils/` - ApiClient, DbClient (TypeORM), WsClient (socket.io)
- `e2e/constants.ts` - E2E environment config

---

## **Database**

### TypeORM Configuration
- **Entities** in `<module>/entity/` folders
- **SnakeNamingStrategy** for table/column names
- **Migrations** in `src/db/migrations/`

### Migration Commands
```bash
bun run mig:gen MyMigration  # Generate migration
bun run mig:run              # Run migrations
bun run mig:revert           # Revert last migration
```

---

## **Password Hashing**

Use Bun's native password API via utility:

```typescript
import { password as passwordUtil } from '@/core/utils/password.util';

// Hash
const hash = await passwordUtil.hash(plaintext);

// Verify
const isValid = await passwordUtil.verify(plaintext, hash);
```

---

## **Path Aliases**

Configured in `tsconfig.json`:
- `@/*` → `src/*`
- `@core/*` → `src/core/*`
- `@config/*` → `src/config/*`

---

## **Scripts Reference**

| Command | Description |
|---------|-------------|
| `bun dev` | Start dev server with hot reload |
| `bun run build` | Build for production |
| `bun start` | Start production build |
| `bun test` | Run unit tests |
| `bun run test:e2e` | Run E2E tests |
| `bun run lint` | Lint and fix |
| `bun run format` | Format with Prettier |
