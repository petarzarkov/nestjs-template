name: app-full-stack

services:
  app-postgres-full:
    container_name: app-postgres-full
    image: public.ecr.aws/docker/library/postgres:17.5
    env_file:
      - .env.full
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_PORT}
    volumes:
      - ${POSTGRES_DATA_DIR}:/var/lib/postgresql/data
    networks:
      - app-full
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PORT: ${POSTGRES_PORT}
      PGPORT: ${POSTGRES_PORT}
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB']
      interval: 2s
      timeout: 5s
      retries: 10

  app-redis-full:
    image: public.ecr.aws/docker/library/redis:8.4.0
    container_name: app-redis-full
    env_file:
      - .env.full
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - redis-data:/data
    command: >
      sh -c "
      if [ -n \"$REDIS_PASSWORD\" ]; then
        redis-server --requirepass $REDIS_PASSWORD
      else
        redis-server
      fi
      "
    healthcheck:
      test:
        - CMD
        - sh
        - -c
        - 'if [ -n "$REDIS_PASSWORD" ]; then redis-cli -a $REDIS_PASSWORD ping; else redis-cli ping; fi'
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - app-full

  app-backend-full:
    container_name: app-backend-full
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        API_PORT: ${API_PORT}
    env_file:
      - .env.full
    environment:
      # Override specific values for Docker environment
      # Keep database host pointing to container name
      POSTGRES_HOST: app-postgres-full
      REDIS_HOST: app-redis-full
      REDIS_PORT: 6379
      NODE_ENV: testing
      APP_ENV: local
    ports:
      - ${API_PORT}:${API_PORT}
    depends_on:
      app-redis-full:
        condition: service_healthy
      app-postgres-full:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -f http://localhost:${API_PORT}/api/service/health || exit 1',
        ]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - app-full

volumes:
  postgres-data:
  redis-data:

networks:
  app-full:
    name: app-network-full
    driver: bridge

